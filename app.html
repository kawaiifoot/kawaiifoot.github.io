<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow - Modern Task Manager</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Style for the task being dragged */
        .task.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- Main container -->
    <div class="container mx-auto max-w-2xl p-4 sm:p-6 lg:p-8">

        <!-- Header Section -->
        <header class="flex justify-between items-center mb-6">
             <div class="flex items-center gap-4">
                <a href="index.html" class="text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400" title="Back to Home">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </a>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">TaskFlow</h1>
            </div>
            <button id="darkModeToggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors duration-200">
                <!-- Sun icon for light mode -->
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-400"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                <!-- Moon icon for dark mode -->
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden text-slate-600 dark:text-slate-400"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </button>
        </header>

        <!-- Task Form Section -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="text" id="title" placeholder="Task Title (max 30 chars)" required maxlength="30" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                <input type="date" id="deadline" required max="2150-12-31" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
            </div>
            <textarea id="details" placeholder="Add more details..." rows="3" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition mb-4"></textarea>
            <button id="addTask" class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold p-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-slate-800 transition-transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                Add Task
            </button>
        </div>

        <!-- Task List Section -->
        <div class="task-list space-y-4" id="taskList">
            <!-- Tasks will be dynamically inserted here -->
        </div>

    </div>

    <!-- Custom Message Box for notifications -->
    <div id="messageBox" class="fixed top-5 right-5 p-4 rounded-lg text-white shadow-lg transition-transform translate-x-[120%] duration-300">
        <span id="messageText"></span>
    </div>

    <script>
        // --- DOM Element Selection ---
        const taskList = document.getElementById('taskList');
        const addTaskBtn = document.getElementById('addTask');
        const darkModeBtn = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        let draggedItem = null;
        let editingTask = null;

        // --- Data Persistence ---

        /**
         * Saves all current tasks from the DOM to localStorage.
         */
        function saveTasks() {
            const tasks = [];
            document.querySelectorAll('.task').forEach(taskElem => {
                tasks.push({
                    title: taskElem.querySelector('.task-title').textContent,
                    deadline: taskElem.querySelector('.task-date').value,
                    details: taskElem.querySelector('.task-details-textarea').value
                });
            });
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        /**
         * Loads tasks from localStorage and populates the list.
         */
        function loadTasks() {
            const savedTasks = localStorage.getItem('tasks');
            if (savedTasks) {
                JSON.parse(savedTasks).forEach(task => createTask(task.title, task.deadline, task.details, false));
            } else {
                 // Add some sample tasks if no tasks are saved
                createTask('Finish project proposal', new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], 'Draft the main points and gather all necessary data for the Q3 proposal.');
                createTask('Call the plumber', new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], 'The kitchen sink is leaking again. Need to schedule a visit.');
                createTask('Buy groceries', new Date().toISOString().split('T')[0], 'Milk, bread, eggs, and cheese.');
            }
        }

        // --- Utility Functions ---

        /**
         * Validates a date string in YYYY-MM-DD format.
         * @param {string} dateStr The date string to validate.
         * @returns {boolean} True if the date is valid and not in the past.
         */
        function isValidDate(dateStr) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return false;
            const [year, month, day] = dateStr.split('-').map(Number);
            if (month < 1 || month > 12 || day < 1 || day > 31) return false;
            
            const dateObj = new Date(dateStr + "T00:00:00"); // Avoid timezone issues
            if (
                dateObj.getFullYear() !== year ||
                dateObj.getMonth() + 1 !== month ||
                dateObj.getDate() !== day
            ) return false;

            if (year > 2150) return false;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dateObj >= today;
        }

        /**
         * Displays a custom notification message.
         * @param {string} message The message to display.
         * @param {boolean} isError If true, shows an error style; otherwise, shows a success style.
         */
        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageBox.classList.remove('bg-red-500', 'bg-green-500', 'translate-x-0', 'translate-x-[120%]');
            
            if (isError) {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-green-500');
            }
            
            messageBox.classList.add('translate-x-0');

            setTimeout(() => {
                messageBox.classList.remove('translate-x-0');
                messageBox.classList.add('translate-x-[120%]');
            }, 3000);
        }

        // --- Core Task Functionality ---

        /**
         * Creates and appends a new task element to the DOM.
         * @param {string} title The title of the task.
         * @param {string} deadline The deadline of the task.
         * @param {string} details The details of the task.
         * @param {boolean} [shouldSave=true] Whether to save the tasks list after creation.
         */
        function createTask(title, deadline, details, shouldSave = true) {
            const task = document.createElement('div');
            task.className = 'task bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm cursor-grab transition-all duration-200 border-l-4 border-transparent';
            task.draggable = true;

            task.innerHTML = `
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-grow">
                        <div class="flex items-center justify-between mb-2">
                            <span class="task-title font-semibold text-slate-800 dark:text-slate-100 break-all">${title}</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>
                            <input type="date" value="${deadline}" disabled maxlength="10" class="task-date bg-transparent p-0 border-none focus:ring-0 w-[130px]" />
                        </div>
                    </div>
                    <div class="task-actions flex flex-col sm:flex-row items-center gap-2 flex-shrink-0">
                        <button class="edit-btn p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                        </button>
                        <button class="delete-btn p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="task-details-wrapper mt-3 hidden">
                    <textarea disabled class="task-details-textarea w-full p-2 bg-slate-100 dark:bg-slate-700 rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">${details}</textarea>
                </div>
            `;
            
            updateTaskBorder(task, deadline);

            const titleSpan = task.querySelector('.task-title');
            const detailsWrapper = task.querySelector('.task-details-wrapper');
            const editBtn = task.querySelector('.edit-btn');
            const deleteBtn = task.querySelector('.delete-btn');

            titleSpan.addEventListener('click', () => detailsWrapper.classList.toggle('hidden'));

            editBtn.addEventListener('click', () => {
                if (editingTask && editingTask !== task) setEditMode(editingTask, false);
                const isEditing = editBtn.innerHTML.includes('save');
                setEditMode(task, !isEditing);
                editingTask = !isEditing ? task : null;
            });

            deleteBtn.addEventListener('click', () => {
                if (editingTask === task) editingTask = null;
                task.classList.add('opacity-0', 'scale-90');
                setTimeout(() => {
                    task.remove();
                    saveTasks();
                    showMessage('Task deleted successfully.');
                }, 300);
            });

            task.addEventListener('dragstart', () => {
                draggedItem = task;
                setTimeout(() => task.classList.add('dragging'), 0);
            });

            task.addEventListener('dragend', () => {
                draggedItem = null;
                task.classList.remove('dragging');
                saveTasks();
            });

            taskList.appendChild(task);
            if (shouldSave) saveTasks();
        }

        /**
         * Toggles the edit mode for a specific task.
         * @param {HTMLElement} taskElem The task element to modify.
         * @param {boolean} enable True to enable edit mode, false to disable.
         */
        function setEditMode(taskElem, enable) {
            const titleSpan = taskElem.querySelector('.task-title');
            const dateInput = taskElem.querySelector('.task-date');
            const detailsTextarea = taskElem.querySelector('.task-details-textarea');
            const editBtn = taskElem.querySelector('.edit-btn');
            const detailsWrapper = taskElem.querySelector('.task-details-wrapper');

            if (enable) {
                titleSpan.contentEditable = true;
                dateInput.disabled = false;
                detailsTextarea.disabled = false;
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M20 6 9 17l-5-5"></path></svg>`;
                taskElem.classList.add('ring-2', 'ring-indigo-500');
                detailsWrapper.classList.remove('hidden');
                titleSpan.focus();
            } else {
                const newTitle = titleSpan.textContent.trim();
                const newDeadline = dateInput.value;

                if (newTitle.length > 30) return showMessage("Title cannot exceed 30 characters.", true);
                if (!isValidDate(newDeadline)) return showMessage("Please enter a valid future date (YYYY-MM-DD).", true);
                if (!newTitle) return showMessage("Title cannot be empty.", true);

                titleSpan.contentEditable = false;
                dateInput.disabled = true;
                detailsTextarea.disabled = true;
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>`;
                taskElem.classList.remove('ring-2', 'ring-indigo-500');
                updateTaskBorder(taskElem, newDeadline);
                saveTasks();
                showMessage('Task updated!');
            }
        }

        /**
         * Updates the left border color of a task based on its deadline.
         * @param {HTMLElement} taskElem The task element.
         * @param {string} deadline The task's deadline.
         */
        function updateTaskBorder(taskElem, deadline) {
            taskElem.classList.remove('border-red-500', 'border-yellow-500', 'border-green-500');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline + "T00:00:00");
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) taskElem.classList.add('border-red-500');
            else if (diffDays <= 3) taskElem.classList.add('border-red-500');
            else if (diffDays <= 7) taskElem.classList.add('border-yellow-500');
            else taskElem.classList.add('border-green-500');
        }

        // --- Event Listeners ---

        addTaskBtn.addEventListener('click', () => {
            const title = document.getElementById('title').value.trim();
            const deadline = document.getElementById('deadline').value;
            const details = document.getElementById('details').value.trim();

            if (title.length > 30) return showMessage("Title cannot exceed 30 characters.", true);
            if (!isValidDate(deadline)) return showMessage("Please enter a valid future date (YYYY-MM-DD).", true);
            if (!title) return showMessage("Please fill in the title.", true);

            createTask(title, deadline, details);
            showMessage('Task added successfully!');

            document.getElementById('title').value = '';
            document.getElementById('deadline').value = '';
            document.getElementById('details').value = '';
        });

        taskList.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(taskList, e.clientY);
            if (draggedItem) {
                if (afterElement == null) taskList.appendChild(draggedItem);
                else taskList.insertBefore(draggedItem, afterElement);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        darkModeBtn.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDarkMode);
            updateThemeIcons(isDarkMode);
        });
        
        function updateThemeIcons(isDark) {
            sunIcon.classList.toggle('hidden', isDark);
            moonIcon.classList.toggle('hidden', !isDark);
        }

        // --- Initial Setup ---
        
        document.addEventListener('DOMContentLoaded', () => {
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('deadline').setAttribute('min', todayStr);

            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) document.documentElement.classList.add('dark');
            updateThemeIcons(savedDarkMode);

            loadTasks();
        });
    </script>
</body>
</html>
